
import random 
from app.server.modules.endpoints.processes import Process
from app.server.modules.endpoints.file_creation_event import File

class Malware:
    """
    A class to model malware
    """
    def __init__(self, name:str, filenames:list, paths:list, recon_processes:list[dict], c2_processes:list[dict]) -> None:
        self.name = name
        self.filenames = filenames
        self.paths = paths
        self.recon_processes = []
        self.c2_processes = []

        self.set_recon_processes(recon_processes)
        self.set_c2_processes(c2_processes)

        self.hashes = []
        # self.c2_ips = c2_ips

    def get_ip(self):
        """
        Get a random IP for list of malware IPs
        """
        return random.choice(self.c2_ips)

    def set_recon_processes(self, processes:"list[dict]") -> None:
        """
        Take a list of recon process names
        set the corresponding File object to the file variable
        """
        for process in processes:
            self.recon_processes.append(
                Malware.get_process_obj(process)
            )

    def set_c2_processes(self, processes:"list[dict]") -> None:
        """
        Take a list of recon process names
        set the corresponding File object to the file variable
        """
        for process in processes:
            self.c2_processes.append(
                Malware.get_process_obj(process)
            )

    def get_implant(self) -> File:
        """
        Returns a file from the malware family
        """
        filename = random.choice(self.filenames)
        return File(
            filename=filename,
            path=random.choice(self.paths)+filename,
            sha256=random.choice(self.hashes)
        )

    def get_recon_process(self) -> Process:
        """
        Returns a random recon process
        """
        return random.choice(self.recon_processes)

    def get_c2_process(self, c2_ip: str) -> Process:
        """
        Returns a random C2 process
        Accepts a C2 IP as a parameter so it can be added to the arguments
        """
        process = random.choice(self.c2_processes)
        process.process_commandline = process.process_commandline.replace("{ip_address}",c2_ip)
        return process
        
    @staticmethod
    def get_process_obj(process: dict) -> Process:
        """
        Take a process dict and load the corresponding
        Process object
        """
        process_args = process.get("process", None)
        return Process(
            process_name=process.get("name"),
            process_commandline=process_args
        )
        

    def __repr__(self) -> str:
        return f"""<Malware: {self.name}>
        Hashes: {self.hashes}
        FileNames: {self.filenames}"""
